# 熵编码

### 信息熵

信息熵是香农参考热力学熵提出的，它代表观察者对某一事件（结果）的未知程度。熵与信息的概念是相对的，**信息量度量的是一个具体事件发生了所带来的信息，而熵则是在结果出来之前对可能产生的信息量的期望**。获取信息意味着消除不确定性，也就是消除熵，他们的数量是相等的。

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/8/170ba613864849d0~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.image)





任何的无损编码方法都不可能使编码后的平均码长小于香农熵，只能使其尽量接近。基于此，对信源进行熵编码的基本思想，是使其前后的码字之间尽量更加随机，尽量减小前后的相关性，更加接近其信源的香农熵。这样在表示同样的信息量时所用的数据长度更短。

熵编码即编码过程中按熵原理不丢失任何信息的无损编码方式，也是有损编码中的一个关键模块，处于编码器的末端。

**信源熵是编码这个信源平均所需要的最小位数。**

**熵编码是无损压缩。**

熵编码有很多种：

霍夫曼编码 （Huffman）

算术编码

**行程编码 （RLE）**

基于上下文的自适应变长编码（CAVLC）

基于上下文的自适应二进制算术编码（CABAC）

JPEG用的是Huffman编码和算术编码，H264用的是CAVLC和CABAC。

#### 哈夫曼编码

我们直接通过一个例子来了解哈夫曼编码。例如我们要发送一份电报“AAAAAAAAAABBBBCCCDDE”，共20个字母，A-10个，B-4个，C-3个，D-2个，E-1个。哈夫曼编码步骤为：

- 每次找出概率最小的两个字母，以这两个字母为左右子节点，生成父节点，父节点的新节点概率为他们的概率之和，给左右路径加上0、1编码（父节点后面会替代其下的所有子节点参与都查找过程中）
- 一直重复上述步骤直到生成根节点

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/8/170badd1f232ed1c~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.image)

通过上图我们可以得到ABCDE的编码

| 字母 | 概率 | 编码 | 字节长度 | 信息熵(log2(1/p)) |
| ---- | ---- | ---- | -------- | ----------------- |
| A    | 0.5  | 1    | 1        | 1                 |
| B    | 0.2  | 00   | 2        | 2.32              |
| C    | 0.15 | 011  | 3        | 2.73              |
| D    | 0.1  | 0100 | 4        | 3.32              |
| E    | 0.05 | 0101 | 4        | 4.32              |

# 视频帧类型

### **什么是I帧？**

I帧或关键帧或帧内帧（I-frame or Key-Frame or Intra-frame）仅由帧内预测的宏块组成。

I帧中的每个宏块只能在同一帧内匹配其他宏块，这意味着，它只能利用帧内“**空间冗余**”来进行压缩。空间冗余是一个术语，用来指单个帧的像素之间的相似性。

I帧在不同的视频编解码器中以不同的形式出现，如IDR、CRA或者BLA。这些不同类型的I帧本质相同：都不存在时域预测。

**I帧**：帧内编码帧（intra picture），I帧通常是每个GOP（MPEG所使用 的一种视频压缩技术）的第一个帧，经过适度地压缩，作为随机访问的参考点，可以当成静态图像。I帧可以看作一个图像经过压缩后的产物，I帧压缩可以得到6：1的压缩比而不会产生任何可觉察的模糊现象。I帧压缩可去掉视频的空间冗余信息，下面即将介绍的P帧和B帧是为了去掉时间冗余信息。

I帧特点:
1)它是一个全帧压缩编码帧。它将全帧图像信息进行JPEG压缩编码及传输;
2)解码时仅用I帧的数据就可重构完整图像;
3)I帧描述了图像背景和运动主体的详情;
4)I帧不需要参考其他画面而生成;
5)I帧是P帧和B帧的参考帧(其质量直接影响到同组中以后各帧的质量);
6)I帧是帧组GOP的基础帧(第一帧),在一组中只有一个I帧;
7)I帧不需要考虑运动矢量;
8)I帧所占数据的信息量比较大。

### **什么是P帧？**

P帧代表预测帧，除了空域预测以外，它还可以通过时域预测来进行压缩。P帧参考前面的帧进行运动估计。P帧中的每个宏块都可以被：

- 时域预测
- 空域预测
- 跳过（skipped）（是指让解码器复制前一帧内的位于相同位置的宏块——0运动向量）

![img](https://pic1.zhimg.com/80/v2-a657f2c082a5ebd3cdf4d5025cdb8b90_720w.webp)

上图中显示了I帧和P帧。如前面讨论，P帧参考前面的I帧或者P帧。图中，帧的编码、解码顺序与它们呈现在用户面前的顺序一致。这是因为P帧只参考前面的图像来进行编码。

**P帧**：前向预测编码帧（predictive-frame），通过将图像序列中前面已编码帧的时间冗余信息充分去除来压缩传输数据量的编码图像，也称为预测帧。P帧表示的是这一帧跟之前的一个I帧（或P帧）的差别**，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终画面**。（也就是差别帧，P帧没有完整画面数据，只有与前一帧的画面差别的数据）

P帧特点:
1)P帧是I帧后面相隔1~2帧的编码帧;
2)P帧采用运动补偿的方法传送它与前面的I或P帧的差值及运动矢量(预测误差);
3)解码时必须将I帧中的预测值与预测误差求和后才能重构完整的P帧图像;
4)P帧属于前向预测的帧间编码。它只参考前面最靠近它的I帧或P帧;
5)P帧可以是其后面P帧的参考帧,也可以是其前后的B帧的参考帧;
6)由于P帧是参考帧,它可能造成解码错误的扩散;
7)由于是差值传送,P帧的压缩比较高。

### **什么是B帧？**

B帧可以参考在其前后出现的帧。B帧中的B就代表双向（Bi-Directional）。如果你的视频编解码器使用基于宏块的压缩（如H.264/AVC所做的一样），那么B帧中的每个宏块都可以：

- 后向预测（使用未来的帧）
- 前向预测（使用过去的帧）
- 无帧间预测，仅帧内预测
- 完全跳过（帧内或帧间预测）

由于B帧可以参考和插入在它之前和之后发生的两个（或更多）帧（在时间维度上），所以它可以显著降低帧的大小，同时保持视频质量。B帧能够利用空间冗余和时间冗余（未来的帧和过去的帧），这使得它在视频压缩中非常有用。

**B帧**：双向预测内插编码帧（bi-directional interpolated prediction frame），以前面的I或P帧和后面的P帧为参考帧,“找出”B帧“某点”的预测值和两个运动矢量,并取预测差值和运动矢量传送。接收端根据运动矢量在两个参考帧中“找出(算出)”预测值并与差值求和,得到B帧“某点”样值,从而可得到完整的B帧。换言之，要解码B帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时CPU的负荷会比较大。

B帧特点

1）B帧是由前面的I或P帧和后面的P帧来进行预测的;

2）B帧传送的是它与前面的I或P帧和后面的P帧之间的预测误差及运动矢量;

3）B帧是双向预测编码帧;

4）B帧压缩比最高,因为它只反映丙参考帧间运动主体的变化情况,预测比较准确;

5）B帧不是参考帧,不会造成解码错误的扩散。

[知乎：什么是I帧、P帧和B帧？](https://zhuanlan.zhihu.com/p/489866125)

[知乎：音视频的I帧、P帧、B帧](https://zhuanlan.zhihu.com/p/342757187)

> 一般而言，帧间预测编码效率比帧内预测更高，其原因在于视频的帧间相关性很强，信息的冗余度很高。例如，有统计结果表明，对内容变化不快的256级灰度视频序列，相邻帧之间的帧间差绝对值超过3的像素平均不到一帧像素的4%；对内容变化剧烈的256%级灰度视频序列，帧间差绝对值平均不到一帧像素的7.5%。

### GOP(序列)和IDR

在H264中图像以**序列**为单位进行组织，一个序列是一段图像编码后的数据流。 一个序列的第一个图像叫做 **IDR 图像**（**立即刷新图像**），IDR 图像都是 I 帧图像。

**H.264 引入 IDR 图像是为了解码的重同步**，当解码器解码到 IDR 图像时，立即将参考帧队列清空，将已解码的数据全部输出或抛弃，重新查找参数集，开始一个新的序列。这样，如果前一个序列出现重大错误，在这里可以获得重新同步的机会。

IDR图像之后的图像永远不会使用IDR之前的图像的数据来解码。 一个序列就是一段内容差异不太大的图像编码后生成的一串数据流。当运动变化比较少时，一个序列可以很长，因为运动变化少就代表图像画面的内容变动很小，所以就可以编一个I帧，然后一直P帧、B帧了。当运动变化多时，可能一个序列就比较短了，比如就包含一个I帧和3、4个P帧。 在视频编码序列中，**GOP即Group of picture**（**图像组**），指两个I帧之间的距离，Reference（**参考周期**）指两个P帧之间的距离。两个I帧之间形成一组图片，就是GOP（Group Of Picture）。

【GOP示意图】

![img](https://pic2.zhimg.com/80/v2-a31db7a2d80cae4b9effcac043bb7bb1_720w.webp)

# 编解码流程

### 一、图片分区

第一步是**将帧**分成几个**分区**，**子分区**甚至更多。分区的目的是为了更精确的处理预测，在微小移动的部分使用较小的分区，而在静态背景上使用较大的分区。越是图像细节复杂的地方分区越多。

编解码器**将这些分区组织**成切片（或瓦片），宏（或编码树单元）和许多子分区。这些分区的最大大小对于不同的编码器有所不同，比如 HEVC 设置成 64x64，而 AVC 使用 16x16，但子分区可以达到 4x4 的大小。

![](https://pic3.zhimg.com/80/v2-a0d41f4157172b78142dbda7432006d2_720w.webp)

### 二、预测

使用帧间预测和帧内预测构成IBP帧。对于帧间预测，我们需要**发送运动向量和残差**；至于帧内预测，我们需要**发送预测方向和残差**。

### 三、转换

使用DCT变换丢弃高频系数。

在我们得到残差块（`预测分区-真实分区`）之后，我们可以用一种方式**变换**它，这样我们就知道**哪些像素我们应该丢弃**，还依然能保持**整体质量**。这个确切的行为有几种变换方式，这里只介绍离散余弦变换（`DCT`），其功能如下：

- 将**像素**块**转换**为相同大小的**频率系数块**。
- **压缩**能量，更容易消除空间冗余。
- **可逆的**，也意味着你可以还原回像素。

我们知道在一张图像中，**大多数能量**会集中在低频部分，所以如果我们将图像转换成频率系数，并**丢掉高频系数**，我们就能**减少描述图像所需的数据量**，而不会牺牲太多的图像质量。 `DCT` **可以把原始图像转换为频率（系数块），然后丢掉最不重要的系数。**

我们从丢掉不重要系数后的系数块重构图像，并与原始图像做对比，如下图所示。

![img](https://pic1.zhimg.com/80/v2-5d3065dc81d962284e6804a9dee108b0_720w.webp)

可以看出它酷似原图像，与原图相比，我们丢弃了**丢弃了67.1875%，而**如何**智能的选择丢弃系数**则是下一步要考虑的问题。

### 四、量化

量化是降低数据表示精度的过程，通过量化可以减少需要编码的数据量，达到压缩的目的。量化可分为标量量化和矢量量化 。标量量化是一维量化，一个幅度对应一个量化结果 。而矢量量化是二维甚至多维量化，两个或两个以上的幅度决定一个量化结果。在图像和视频编码中 ， 普遍采用标量量化 。量化过程存在量化误差，这种误差称为量化噪声。

量化是一种有损压缩。

### 五、Z扫描和熵编码

在DCT图像变换完成后，需要把数据从高频到低频频域强度信号进行筛选等操作，为了方便算法进行操作，最好转化为一个一维的数据，而如果每一行都从左到右写入到一维数据表中，会导致高频和低频频域信号混杂在整个表不同的部位，不方便进行霍夫曼编码等操作。

**另外，它还有一个额外的好处，就是以此方式把二维数据转换为一维数据后，并不需要知道原来二维数据的边长，一维数据可以以同样的规则重新填充为降维前的大小。**（问：如何保证能在最大长度时折回，是二分吗，或者通过全长的1/2确定最大折回）

之后进行熵编码，进行最后的无损压缩

# 量化

量化的概念：量化是降低数据表示精度的过程，通过量化可以减少需要编码的数据量，达到压缩数据的目的。量化的过程是将连续的模拟信号近似为有限的离散值。

量化的损失来自于原图像和重构以后图像的误差，也就是“截断”的过程。

### 量化如何控制码率的？

第一步为位分配，即根据目标码率以及缓冲区状态，为每一帧图像分配一定的比特数；

第二步通过调整量化参数使得编码该帧图像所用的比特数接近分配给该帧的比特数，从而达到目标码率。通常可以在宏块、条带或帧级进行量化参数调整以产生所需要的编码码流。

#### 码率概念

码率，也称为比特率，或叫位速率，是单位时间内视频（或音频）的数据量，单位是bps，一般使用kbps或Mbps

例如，计算一个1920*1080 25p 8位深视频的码率

(1920×1080)×(8×3)×25÷1024÷1024 = 1186Mbps   （约1.2Gbps）

通常，码率越低，表示压缩程度越高，画质越差。码率越高，视频质量相对越高，视频文件也就越大。

#### CBR、VBR、ABR

**CBR**（Constants Bit Rate）即[固定码率](http://baike.baidu.com/view/336085.htm)，就是静态（恒定）[比特率](http://baike.baidu.com/view/56355.htm)的意思，CBR是一种固定[采样率](http://baike.baidu.com/view/53433.htm)的压缩方式。优点是压缩快，能被大多数软件和设备支持，缺点是占用空间相对大，效果不十分理想，现已逐步被[VBR](http://baike.baidu.com/view/56353.htm)的方式取代。

当形容编解码器的时候，[CBR编码](http://baike.baidu.com/view/1218795.htm)指的是编码器的输出码率（或者解码器的输入码率）应该是固定制（常数）。当在一个带宽受限的信道中进行多媒体通讯的时候CBR是非常有用的，因为这时候受限的是最高码率，CBR可以更好的易用这样的信道。但是CBR不适合进行存储，因为CBR将导致没有足够的码率对复杂的内容部分进行编码(从而导致质量下降)，同时在简单的内容部分会浪费一些码率。

**适用场景：**一般也不建议使用这种方式，虽然输出的码率总是处于一个稳定值，但是质量不稳定，不能充分有效利用网络带宽，因为这种模型不考虑视频内容的复杂性，把所有视频帧的内容统一对待。但是有些编码软件只支持固定质量或者固定码率方式，有时不得不用。用的时候在允许的带宽范围内尽可能把带宽设置大点，以防止复杂运动场景下视频质量很低，如果设置的不合理，在运动场景下直接就糊的看不成了。

**VBR**（VariableBit Rate）[动态比特率](http://baike.baidu.com/view/1844702.htm)。也就是非固定的比特率，[音频编码](http://baike.baidu.com/view/1531030.htm)软件在编码时根据音频数据的复杂程度即时确定使用什么比特率，这是以质量为前提兼顾文件大小的编码方式。

有两种调控模式：质量优先模式和2PASS二次编码模式。

**质量优先模式：**

不考虑输出视频文件的大小，完全按照视频的内容复杂程度来分配码率，这样视频的播放效果质量最好。

**二次编码方式2PASS：**

第一次编码检测视频内容的简单和复杂部分，同时确定简单和复杂的比例。第二遍编码会让视频的平均码率不变，复杂的地方分配多bit,简单地方分配少bit。这种编码虽然很好，但是速度会跟不上。

**适用场景：**VBR适用于那些对带宽和编码速度不太限制，但是对质量有很高要求的场景。特别是在运动的复杂场景下也可以保持比较高的清晰度且输出质量比较稳定，适合对延时不敏感的点播，录播或者存储系统。

**ABR：**(Average Bit Rate）恒定平均目标码率，简单场景分配较低bit,复杂场景分配足够bit，使得**有限的bit数**能够在不同场景下合理分配，这类似VBR。同时一定时间内，平均码率**又接近设置的目标码率**，这样可以控制输出文件的大小，这又类似CBR。可以认为是CBR和VBR的折中方案，这是大多人的选择。特别在对质量和视频带宽都有要求的情况下，可以优先选择该模式，一般速度是VBR的两倍到三倍，相同体积的视频文件质量却比CBR好很多。 

**适用场景：**ABR在直播和低延时系统用的比较多，因为只编码了一次，所以速度快，同时兼顾了视频质量和带宽,对于转码速度有要求的情况下也可以选择该模式。B站的大部分视频就选择了该模式。

### 量化参数QP的概念

量化参数qp是视频编码中用于控制视频质量和码率的一个重要参数。在视频编码中，每个宏块都需要进行量化，qp就是控制量化的参数。qp值越大，量化的步长越大，编码后的码流越小，但图像质量也会相应下降；反之，qp值越小，量化的步长越小，编码后的码流越大，但图像质量也会相应提高。

在H.264/AVC编码中，qp值的范围为0\~51，其中0表示无损编码，51表示最大压缩。一般来说，qp值在18\~28之间时，视频的质量和码率都比较适中。在实际应用中，我们可以通过手动调整qp值或者使用自适应qp算法来控制视频的质量和码率。合理的qp值选择可以大大提高视频编码的效率和质量。

### 如何根据码率和硬盘容量计算录制剩余时间

假定硬盘容量单位是G，码率是kbps

硬盘容量×1024×1021×8÷码率 = 时间（s）

# 图像质量评价

主要包括两个方面：**图像的逼真度和图像的可懂度**

逼真度描述被评价图像与标准图像的偏离程度，可懂度表示图像能向人或计算机提供信息的能力

### 主观方法、标准

主观质量评价方法（mean opinion score，MOS）是通过对观察者的评分归一化来判断图像的质量。让观测者根据事先规定的评价尺度或凭借自己的经验，对测试图像按视觉效果进行质量判断，并给出质量分数，然后对所有观测者给出的分数进行加权平均，所得的结果即为图像的主观质量评价。

根据（ITU-R，2000）的标准，给出一些方法：

**双刺激连续质量标度方法（DSCQS）**、**双刺激损伤标度方法（DSIS）**、**单刺激连续质量标度方法（SSCQE）**

这些方法中存在两种度量尺度：绝对性尺度和相对性尺度。绝对尺度是将图像直接按照视觉感受分级评分。相对尺度是在一组图像中，按该组图像的相对优劣进行分级。《数字视频编码技术原理，高文等》中给出了5个评分等级。

### 客观标准

最常见的分类方法为根据参考源的可用性分为：全参考、部分参考、无参考三种类型。

全参考中，要将评价的“失真”图像与“标准”参考图像进行比较得到评价结果。部分参考质量评价方法中，关于参考图像可以得到部分的特征信息，然后吐过这些部分信息完成对“失真”图像的质量评估。无参考，需要在不借助任何参考图像的前提下，直接对“失真”图像质量进行评估。

#### 峰值信噪比PSNR算法

**图像质量评价指标PSNR(峰值信噪比)**

##### 一、PSNR基本定义

PSNR全称为“Peak Signal-to-Noise Ratio”，中文意思即为峰值信噪比，是衡量图像质量的指标之一。PSNR是基于MSE(均方误差)定义，对给定一个大小为m*n的原始图像I和对其添加噪声后的噪声图像K，其MSE可定义为：

![](https://img-blog.csdnimg.cn/ac2b8ecf576146eaa9221177b2454a6e.png#pic_center)

则PSNR可定义为：

![](https://img-blog.csdnimg.cn/34de3a3d0e134342ae834ce840e1511a.png#pic_center)

其中MAXI为图像的最大像素值，PSNR的单位为dB。若每个像素由8位二进制表示，则其值为2^8-1=255。但注意这是针对灰度图像的计算方法，若是彩色图像，通常可以由以下方法进行计算：

方法一：计算RGB图像三个通道每个通道的MSE值再求平均值，进而求PSNR

方法二：直接使用matlab的内置函数psnr()(注意该函数将所有图像当成灰度图像处理)。

**方法三：将图像转为YCbCr格式，只计算Y分量即亮度分量的PSNR。**

##### 二、PSNR评价标准

PSNR值越大，表示图像的质量越好，一般来说：

**（1）高于40dB：说明图像质量极好(即非常接近原始图像)**
**（2）30—40dB：通常表示图像质量是好的(即失真可以察觉但可以接受)**
**（3）20—30dB：说明图像质量差**
**（4）低于20dB：图像质量不可接受**

[图像处理之图像质量评价指标PSNR(峰值信噪比)](https://blog.csdn.net/qq_44111805/article/details/127676377)

